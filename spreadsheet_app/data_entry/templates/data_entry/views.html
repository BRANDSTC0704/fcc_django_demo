{% load static %}

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCC DEMO - Datenerfassen Produktion</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'data_entry/styles.css' %}">
    <link rel="shortcut icon" type="image/png" href="{% static 'favicon.png' %}" >
</head>


<body class="container mt-5">
    
    <div class="text-center">
        <img src="{% static 'logo.png' %}" alt="Logo" width="150">
    </div>
    &nbsp;

    <h2 class="text-center">PROD/LINZ - Tagesbericht Sortierung - Datendarstellung</h2>

    <label for="date-filter" value="{{ request.GET.date|default:'' }}">Filter nach Datum:</label>
    <input type="date" id="date-filter" value="{{ selected_date|default:heute }}">

    <ul class="text-center mt-3">
        <a href="{% url 'entrance_page' %}" class="btn btn-secondary">Startseite</a>
        <a href="{% url 'form_page' %}" class="btn btn-secondary">Dateneingabe</a>
    </ul>


    <form method="post", itemid="Employees">
        {% csrf_token %}
    <!-- Employees Table -->
    <h3>Mitarbeiter</h3>
    {{ employee_formset.management_form }}
    <table class="table table-striped">
        <thead>
            <tr >
                <th>angelegt am</th>
                <th>Vorname</th>
                <th>Nachname</th>
                <th>Arbeitsbeginn</th>
                <th>Arbeitsende</th>
                <th>Pause (h)</th>
                <th>Abwesenheitsgrund</th>                
            </tr>
        </thead>
        <tbody  id="employee-tbody" data-formset-prefix="employee_formset" data-empty-form="{{ employee_formset.empty_form|escapejs }}">
            {% for form in employee_formset %}
            <tr class="form-row">
                {{ form.id }} 
                <td>{{ form.instance.created_at|date:"d.m.Y H:i" }}</td>
                <td class="cte">{{ form.first_name }}</td>
                <td class="cte">{{ form.surname }}</td>
                <td class="cte">{{ form.work_start }}</td>
                <td class="cte">{{ form.work_end }}</td>
                <td class="cte">{{ form.break_time }}</td>
                <td class="cte">{{ form.absence }}</td>                
                <td>
                {{ form.DELETE }} Markieren zum L√∂schen
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">√Ñnderungen speichern</button>
    <button id="add-employee" type="button" class="btn btn-info">Weiteren Mitarbeiter anlegen</button>
    </form>

    <form method="post">
        {% csrf_token %}
     <!-- Work Categories Table -->
      <h3>Modul 3 - Gewerbe - PET - Bonus</h3>
        {{ work_category_formset.management_form }}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>angelegt am</th>
                    <th>Reinigung (h)</th>
                    <th>Wartung / Reparatur (h)</th>
                    <th>St√∂rung (h)</th>
                </tr>
            </thead>
            <tbody 
            id="work-category-tbody" data-formset-prefix="work_category_formset" 
            data-empty-form="{{ work_category_formset.empty_form|escapejs }}">
            </tbody>
                {% for form in work_category_formset %}
                <tr>
                    {{ form.id }} 
                    <td>{{ form.instance.created_at|date:"d.m.Y H:i" }}</td>
                    <td>{{ form.cleaning }}</td>
                    <td>{{ form.maintenance }}</td>
                    <td>{{ form.interruption }}</td>
                    <td>
                        {{ form.DELETE }} Markieren zum L√∂schen
                    </td>
                    <input type="hidden" name="form-{{ forloop.counter0 }}-DELETE" class="delete-input">
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-success">√Ñnderungen speichern</button>
        <button id="add-work-category" type="button" class="btn btn-warning">Weitere √úbersicht anlegen</button>
    </form>
 
    <form method="post">
        {% csrf_token %}
    <!-- Work Hours Table -->
    <h3>Z√§hlerstand Betriebsstunden</h3>
    {{ work_hours_formset.management_form }}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>angelegt am</th>
                <th>Beginnzeit</th>
                <th>Endzeit</th>
                <th>Differenz</th>
                <th></th>                
            </tr>
        </thead>
        <tbody 
            id="work-hours-tbody" data-formset-prefix="work_hours_formset" 
            data-empty-form="{{ work_hours_formset.empty_form|escapejs }}">
        </tbody>
            {% for form in work_hours_formset %}
            <tr>
                {{ form.id }}  
                <td>{{ form.instance.created_at|date:"d.m.Y H:i" }}</td>
                <td>{{ form.start_time }}</td>
                <td>{{ form.end_time }}</td>
                <td>{{ form.instance.difference  }} </td>
                <td>
                    {{ form.DELETE }} 
                    Markieren zum L√∂schen
                </td>
                <input type="hidden" name="form-{{ forloop.counter0 }}-DELETE" class="delete-input">
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">√Ñnderungen speichern</button>
    <button id="add-work-hours" type="button" class="btn btn-info">Weitere Betriebsstundenliste anlegen</button>
    </form>

    <form method="post">
        {% csrf_token %}
        <!-- Container Count Table -->
        <h3>Anzahl Container</h3>
        {{ container_count_formset.management_form }}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>angelegt am</th>
                    <th>Alu Dosen (K√ºbel - 8,5 kg)</th>
                    <th>Holz (Container - 6 t)</th>
                    <th>Karton (Container - 6 t)</th>
                    <th>Magnetschrott (Container - 6 t)</th>
                    <th>Kanister (1 Container = 5 Ballen)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="container-tbody" data-formset-prefix="container_count_formset" 
                   data-empty-form="{{ container_count_formset.empty_form|escapejs }}">
            </tbody>

                {% for form in container_count_formset %}
                <tr>
                    {{ form.id }} 
                    <td>{{ form.instance.created_at|date:"d.m.Y H:i" }}</td>
                    <td>{{ form.alu }}</td>
                    <td>{{ form.holz }}</td>
                    <td>{{ form.karton }}</td>
                    <td>{{ form.magnetschrott }}</td>
                    <td>{{ form.kanister }}</td>
                    <td>
                        {{ form.DELETE }} 
                        Markieren zum L√∂schen
                    </td>
                    <input type="hidden" name="form-{{ forloop.counter0 }}-DELETE" class="delete-input">
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-success">√Ñnderungen speichern</button>
        <button id="add-container" type="button" class="btn btn-warning">Weitere Containerliste anlegen</button>
        </form>


        <!-- Protocollist -->
        <h3>protokolliert von</h3>
        <form method="post", label="protocollist">
        {% csrf_token %}
        {{ protocollist_formset.management_form }}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>angelegt am</th>
                    <th>Protokoll angelegt von</th>
                    <th></th>
                </tr>
            </thead>
                <tbody 
                id="protocollist-tbody" data-formset-prefix="protocollist_formset" 
                data-empty-form="{{ protocollist_formset.empty_form|escapejs }}">
                </tbody>
                {% for form in protocollist_formset %}
                <tr>
                    {{ form.id }}  
                    <td>{{ form.instance.created_at|date:"d.m.Y H:i" }}</td>
                    <td>{{ form.protocollist }}</td>
                    <td>
                        {{ form.DELETE }} 
                        Markieren zum L√∂schen
                    </td>
                    <input type="hidden" name="form-{{ forloop.counter0 }}-DELETE" class="delete-input">
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary">√Ñnderungen speichern</button>
        <button id="add-protocollist" type="button" class="btn btn-info">Weiteren Protokollisten anlegen</button>
    </form>

    <ul class="text-center mt-3">
        <a href="{% url 'entrance_page' %}" class="btn btn-secondary">Startseite</a>
        <a href="{% url 'form_page' %}" class="btn btn-secondary">Dateneingabe</a>
    </ul>

</body>
</html>

<script>
    
    // delete rows 
    document.addEventListener("DOMContentLoaded", function () {
    document.body.addEventListener("click", function (event) {
        if (event.target.classList.contains("remove-row")) {
            let row = event.target.closest("tr");
            let deleteInput = row.querySelector("input[type='checkbox'][name$='-DELETE']");
            
            if (deleteInput) {
                deleteInput.checked = true;  // Mark for deletion
            }

            // row.style.display = "none";  // Hide row from UI
            updateTotalForms();
        }
    });

    function updateTotalForms() {
        document.querySelectorAll("[data-formset-prefix]").forEach(tableBody => {
            let prefix = tableBody.dataset.formsetPrefix;
            let totalFormsInput = document.querySelector(`input[name="form-TOTAL_FORMS"]`);
            
            if (totalFormsInput) {
                let visibleRows = tableBody.querySelectorAll("tr:not([style='display: none;'])").length;
                totalFormsInput.value = visibleRows;
            }
        });
    }
});
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll("input[name*='break_time']").forEach(input => {
            // Convert dot to comma when the page loads
            input.value = input.value.replace(".", ",");
    
            // Convert comma to dot before form submission
            input.addEventListener("change", function() {
                this.value = this.value.replace(",", ".");
            });
        });
    });
          
    document.addEventListener("DOMContentLoaded", function () {
    let dateFilter = document.getElementById("date-filter");

    if (dateFilter) {
        function applyDateFilter(selectedDate, preventReload = false) { // Added preventReload param
            if (selectedDate) {
                let newUrl = new URL(window.location.href);
                newUrl.searchParams.set("date", selectedDate);
                if (!preventReload) { // Only reload if preventReload is false
                    window.location.href = newUrl.toString();
                } else {
                  //If we prevent reload, we may want to update the url bar without reloading.
                  window.history.replaceState({}, document.title, newUrl.toString());
                }
            }
        }

        dateFilter.addEventListener("change", function () {
            applyDateFilter(this.value);
        });

        // Check for initial value, but prevent reload on initial load
        if (dateFilter.value) {
            applyDateFilter(dateFilter.value, true); // Pass true to prevent reload
        }
    }
});

// Add new element
document.addEventListener("DOMContentLoaded", function () {
    function setupFormset(tableBodyId, addButtonId, emptyFormHtml, formsetPrefix, isWorkHours = false) {
        let tableBody = document.getElementById(tableBodyId);
        let addButton = document.getElementById(addButtonId);
        let totalForms = document.querySelector(`input[name="${formsetPrefix}-TOTAL_FORMS"]`);  // ‚úÖ Correct TOTAL_FORMS field
        let formIdx = Number(totalForms.value);

        emptyFormHtml = decodeEntities(emptyFormHtml);

        addButton.addEventListener("click", function () {
            let newRow = document.createElement("tr");

            let emptyForm = emptyFormHtml.replace(/__prefix__/g, formIdx);
            let tempDiv = document.createElement("div");
            tempDiv.innerHTML = emptyForm;
            let formFields = Array.from(tempDiv.querySelectorAll("input, select, textarea"));

            // üî• Filter out DELETE fields
            formFields = formFields.filter(field => !field.name.includes("DELETE"));

            // Get current date and time in format: "dd.mm.yyyy HH:MM:SS"
            let now = new Date();
            let formattedDate = now.toLocaleDateString("de-DE") + " " + now.toLocaleTimeString("de-DE");

            let rowContent = `<td class="cte">${formattedDate}</td>`;

            if (isWorkHours) {
                // Find work_start and work_end fields
                let workStart = formFields.find(f => f.name.includes("start_time"));
                let workEnd = formFields.find(f => f.name.includes("end_time"));

                // Create a column for difference calculation
                let diffCell = `<td class="cte difference-cell">-</td>`;

                rowContent += `
                    <td class="cte">${workStart.outerHTML}</td>
                    <td class="cte">${workEnd.outerHTML}</td>
                    ${diffCell}
                `;

                function updateDifference(startInput, endInput, diffElement) {
                    if (startInput.value && endInput.value) {
                        let startTime = parseTime(startInput.value);
                        let endTime = parseTime(endInput.value);
                        let diffMs = endTime - startTime;
                        
                        let diffHours = Math.floor(diffMs / 3600000);
                        let diffMinutes = Math.floor((diffMs % 3600000) / 60000);

                        diffElement.textContent = `${String(diffHours).padStart(2, "0")}:${String(diffMinutes).padStart(2, "0")}`;
                    }
                }

                // Attach event listeners for real-time updates
                setTimeout(() => {
                    let startInput = tableBody.lastElementChild.querySelector(`input[name="${workStart.name}"]`);
                    let endInput = tableBody.lastElementChild.querySelector(`input[name="${workEnd.name}"]`);
                    let diffElement = tableBody.lastElementChild.querySelector(".difference-cell");

                    function onInputChange() {
                        updateDifference(startInput, endInput, diffElement);
                    }

                    startInput.addEventListener("input", onInputChange);
                    endInput.addEventListener("input", onInputChange);
                }, 0);
            } else {
                formFields.forEach(field => rowContent += `<td class="cte">${field.outerHTML}</td>`);
            }

            newRow.innerHTML = rowContent;
            newRow.classList.add("form-row");
            tableBody.appendChild(newRow);

            formIdx++;
            totalForms.value = formIdx; // ‚úÖ Correctly updates the TOTAL_FORMS for each formset
        });
    }

    function parseTime(timeStr) {
        let [hours, minutes] = timeStr.split(":").map(Number);
        return new Date(0, 0, 0, hours, minutes, 0);
    }

    function decodeEntities(encodedString) {
        let textArea = document.createElement("textarea");
        textArea.innerHTML = encodedString;
        return textArea.value;
    }

    // üî• Apply to all formsets dynamically
    let formsets = [
        { tbodyId: "employee-tbody", buttonId: "add-employee", emptyForm: `{{ employee_formset.empty_form|escapejs }}`, prefix: "employee" },
        { tbodyId: "work-category-tbody", buttonId: "add-work-category", emptyForm: `{{ work_category_formset.empty_form|escapejs }}`, prefix: "work_category" },
        { tbodyId: "work-hours-tbody", buttonId: "add-work-hours", emptyForm: `{{ work_hours_formset.empty_form|escapejs }}`, prefix: "work_hours", isWorkHours: true },
        { tbodyId: "container-tbody", buttonId: "add-container", emptyForm: `{{ container_count_formset.empty_form|escapejs }}`, prefix: "container" },
        { tbodyId: "protocollist-tbody", buttonId: "add-protocollist", emptyForm: `{{ protocollist_formset.empty_form|escapejs }}`, prefix: "protocollist" }
    ];

    formsets.forEach(({ tbodyId, buttonId, emptyForm, prefix, isWorkHours }) => {
        if (document.getElementById(tbodyId)) {
            setupFormset(tbodyId, buttonId, emptyForm, prefix, isWorkHours);
        }
    });
});


</script>